<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¿„è¯­å•è¯è‡ªä¿®å®¤</title>
    <!-- å¼•å…¥å›½å†…ç¨³å®šçš„ React åŸºç¡€åº“ -->
    <script src="https://cdn.staticfile.org/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.staticfile.org/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.staticfile.org/babel-standalone/7.22.20/babel.min.js"></script>
    
    <!-- å†…ç½® Tailwind åŸºç¡€æ ·å¼ -->
    <link href="https://cdn.staticfile.org/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">

    <style>
        /* --- æ ¸å¿ƒæ ·å¼è¡¨ --- */
        :root {
            --bg-color: #F7F5F0;
            --text-main: #2C332C;
            --text-sub: #9CA3AF;
            --primary-green: #7A8665;
            --deep-green: #3F4A2C; /* æ›´åŠ æ·±çš„ç»¿è‰²ï¼Œç”¨äºå¼ºè°ƒé‡éŸ³ */
            --primary-clay: #BC8A7B;
            --soft-white: #ECEBE5;
            --white: #FFFFFF;
            --border-color: #D9D8D2;
        }

        body {
            font-family: "Times New Roman", Times, serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            -webkit-font-smoothing: antialiased;
            -webkit-text-size-adjust: 100%;
        }

        .cn-font { font-family: system-ui, -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; }

        .app-wrapper {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 90vh;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .header { width: 100%; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; }
        .brand { display: flex; align-items: center; gap: 12px; }
        .logo { background-color: var(--primary-green); color: white; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 0 0 4px var(--soft-white); }
        .title h1 { font-size: 1.2rem; font-weight: bold; margin: 0; }
        .title p { font-size: 0.65rem; color: var(--primary-green); font-weight: bold; text-transform: uppercase; letter-spacing: 1px; margin: 2px 0 0 0; }

        /* æŒ‰é’® */
        .btn-group { background-color: var(--soft-white); padding: 4px; border-radius: 12px; display: flex; gap: 4px; }
        .btn { border: none; background: transparent; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; font-weight: bold; color: #888; cursor: pointer; transition: all 0.2s; }
        .btn.active { background-color: var(--white); color: var(--primary-green); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* è¯¾ç¨‹å¯¼èˆª */
        .lesson-nav { display: flex; gap: 8px; overflow-x: auto; width: 100%; padding-bottom: 5px; justify-content: center; margin-bottom: 20px; }
        .lesson-nav::-webkit-scrollbar { display: none; }
        .lesson-btn { min-width: 45px; height: 36px; border: 2px solid var(--border-color); background: var(--white); border-radius: 10px; font-weight: bold; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; }
        .lesson-btn.active { background-color: var(--primary-green); color: var(--white); border-color: var(--primary-green); }

        /* é—ªå¡å®¹å™¨ - å¼ºåˆ¶å°ºå¯¸ä¸€è‡´ */
        .card-container { width: 100%; max-width: 340px; aspect-ratio: 3/4; position: relative; perspective: 2000px; margin-bottom: 20px; cursor: pointer; user-select: none; -webkit-user-select: none; }
        @media (min-width: 600px) { .card-container { aspect-ratio: 16/10; max-width: 600px; } }
        
        .card-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1); transform-style: preserve-3d; }
        .card-inner.flipped { transform: rotateY(180deg); }
        
        /* å¼ºåˆ¶æ­£åé¢ç»å¯¹å®šä½æ’‘æ»¡å®¹å™¨ */
        .card-face { position: absolute; top: 0; left: 0; width: 100%; height: 100%; backface-visibility: hidden; -webkit-backface-visibility: hidden; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.06); padding: 20px; box-sizing: border-box; overflow: hidden; background-color: var(--white); }
        .card-front { border: 1px solid var(--soft-white); z-index: 2; }
        .card-back { background-color: var(--primary-green); color: var(--white); transform: rotateY(180deg); z-index: 1; border: 6px solid rgba(255,255,255,0.15); }

        /* å•è¯æ’ç‰ˆ */
        .word-display { display: flex; flex-wrap: wrap; justify-content: center; align-items: flex-end; line-height: 1; }
        .char-container { display: inline-block; position: relative; padding: 0; margin: 0; }
        .char { font-weight: bold; transition: color 0.3s; display: inline-block; }
        .char.root { color: var(--primary-clay); }
        
        /* --- é‡éŸ³ç¬¦å·æ ¸å¿ƒä¼˜åŒ– --- */
        .stress-mark {
            position: absolute;
            left: 50%;
            /* å‘å·¦å¹³ç§»ä»¥å¯¹é½å…ƒéŸ³è§†è§‰ä¸­å¿ƒ */
            transform: translateX(-35%); 
            font-family: Arial, sans-serif; 
            font-weight: 900;
            pointer-events: none;
            line-height: 1;
            width: 0; height: 0; overflow: visible;
            display: flex; justify-content: center; align-items: flex-end;
            z-index: 10;
        }

        /* ã€é‡ç‚¹è°ƒæ•´ã€‘é—ªå¡æ­£é¢å¤§å­—æ¨¡å¼ï¼šé‡éŸ³ç‰¹å¤§ã€ç‰¹æ˜æ˜¾ã€ç‰¹è¿‘ */
        .text-lg .char { font-size: 3.2rem; }
        .text-lg .stress-mark { 
            top: 0.22em;  /* æå¤§ä¸‹æ²‰ï¼Œè´´è¿‘å­—æ¯ */
            font-size: 0.85em; /* æå¤§å­—å· */
            color: var(--deep-green); /* æ·±ç»¿è‰² */
            text-shadow: 0.5px 0 0 var(--deep-green); /* åŠ ç²—æè¾¹ */
        }

        /* å˜ä½å°å­—æ¨¡å¼ - æ¢å¤ä¸ºæ™®é€šå¤§å° */
        .text-md .char { font-size: 1.4rem; }
        .text-md .stress-mark { 
            top: 0.15em; 
            font-size: 0.6em; /* æ¢å¤æ­£å¸¸å¤§å° */
            color: white; 
            text-shadow: 0.5px 0 0 white;
        }
        
        /* å˜ä½æ­£é¢æ˜¾ç¤ºçš„é¢œè‰² */
        .conj-front .stress-mark { color: var(--primary-green) !important; text-shadow: 0.5px 0 0 var(--primary-green) !important; font-size: 0.7em; top: 0.1em; }
        .conj-back .stress-mark { color: white !important; text-shadow: 0.5px 0 0 white !important; font-size: 0.6em; }

        .text-white .char { color: white !important; }
        .text-white .stress-mark { color: white !important; text-shadow: 0.5px 0 0 white !important; }

        @media (max-width: 600px) { .text-lg .char { font-size: 2.8rem; } }

        /* åº•éƒ¨æ§åˆ¶æ  */
        .controls { width: 100%; max-width: 340px; display: flex; align-items: center; gap: 10px; margin-top: 15px; }
        .nav-btn { background: white; border: 1px solid var(--border-color); width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary-green); cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; }
        .nav-btn:active { transform: scale(0.95); background: var(--soft-white); }
        .slider-container { flex: 1; text-align: center; }
        .slider { -webkit-appearance: none; width: 100%; height: 5px; background: var(--border-color); border-radius: 3px; outline: none; }
        .slider::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; border-radius: 50%; background: var(--primary-green); cursor: pointer; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .progress-text { font-size: 0.9rem; font-weight: bold; color: var(--text-main); margin-top: 5px; font-family: "Times New Roman", serif; }

        /* å…¶ä»–è¾…åŠ©æ ·å¼ */
        .back-content { width: 100%; height: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .cn-mean { font-family: system-ui, sans-serif; font-size: 1.8rem; font-weight: bold; margin-bottom: 15px; text-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .info-card { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.25); border-radius: 12px; padding: 12px; width: 100%; max-width: 320px; margin-bottom: 8px; }
        .info-label { font-size: 0.6rem; text-transform: uppercase; opacity: 0.8; letter-spacing: 1px; font-weight: bold; margin-bottom: 4px; }
        .game-panel { background: var(--white); border-radius: 24px; padding: 20px; width: 100%; box-shadow: 0 5px 15px rgba(0,0,0,0.03); border: 1px solid var(--soft-white); }
        .game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .game-btn { background: var(--white); border: 2px solid var(--soft-white); border-radius: 12px; padding: 8px; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 1rem; font-weight: bold; color: var(--text-main); cursor: pointer; transition: all 0.2s; }
        .game-btn.selected { background: var(--primary-green); color: var(--white); border-color: var(--primary-green); transform: translateY(-2px); }
        .game-btn.solved { opacity: 0.3; cursor: default; background: #f0f0f0; }
        .quiz-option { height: 60px; border-radius: 12px; border: 2px solid var(--soft-white); background: white; font-size: 1rem; font-weight: bold; cursor: pointer; color: var(--text-main); }
        .quiz-option.correct { background: var(--primary-green); color: white; border-color: var(--primary-green); }
        .quiz-option.wrong { opacity: 0.5; border-color: var(--primary-clay); color: var(--primary-clay); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback, useRef } = React;

        // å†…ç½® SVG å›¾æ ‡
        const Icons = {
            BookOpen: () => <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Layers: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>,
            RefreshCw: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>,
            ChevronLeft: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"/></svg>,
            ChevronRight: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="9 18 15 12 9 6"/></svg>,
            Check: () => <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>,
            Award: () => <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></svg>
        };

        const vocabulary = [
          // Lesson 1
          { ru: 'Ğ´Ğ½ĞµĞ²Ğ½Ğ¸Ğº', stressIdx: 5, root: 'Ğ´Ğ½ĞµĞ²', cn: 'æ—¥è®°', lesson: 1, related: 'Ğ´ĞµĞ½ÑŒ (å¤©), Ğ´Ğ½ĞµĞ²Ğ½Ğ¾ÌĞ¹ (ç™½å¤©çš„)' },
          { ru: 'Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°Ğº', stressIdx: 1, root: 'Ğ·Ğ°Ğ²Ñ‚Ñ€', cn: 'æ—©é¥­', lesson: 1, related: 'Ğ·Ğ°ÌĞ²Ñ‚Ñ€Ğ° (æ˜å¤©)' },
          { ru: 'ĞºÑ€ÑƒĞ¶Ğ¾Ğº', stressIdx: 4, root: 'ĞºÑ€ÑƒĞ¶', cn: 'å°ç»„', lesson: 1, related: 'ĞºÑ€ÑƒĞ³ (åœ†)' },
          { ru: 'Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ°', stressIdx: 5, root: 'Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚', cn: 'æ•°å­¦', lesson: 1, related: 'Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ÌÑ‡ĞµÑĞºĞ¸Ğ¹' },
          { ru: 'ÑĞ¾Ñ€ĞµĞ²Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ', stressIdx: 8, root: 'Ñ€ĞµĞ²Ğ½', cn: 'æ¯”èµ›', lesson: 1, related: 'Ñ€ĞµĞ²Ğ½Ğ¸ÌĞ²Ñ‹Ğ¹ (ç«äº‰)' },
          { ru: 'ÑÑ‚Ğ¾Ğ»Ğ¾Ğ²Ğ°Ñ', stressIdx: 4, root: 'ÑÑ‚Ğ¾Ğ»', cn: 'é£Ÿå ‚', lesson: 1, related: 'ÑÑ‚Ğ¾Ğ» (æ¡Œå­), Ğ½Ğ°ÑÑ‚Ğ¾ÌĞ»ÑŒĞ½Ñ‹Ğ¹ (æ¡Œä¸Šçš„)' },
          { ru: 'ÑƒĞ¶Ğ¸Ğ½', stressIdx: 0, root: 'ÑƒĞ¶', cn: 'æ™šé¥­', lesson: 1, related: 'ÑƒÌĞ¶Ğ¸Ğ½Ğ°Ñ‚ÑŒ (åƒæ™šé¥­)' },
          { ru: 'Ñ…Ğ¾ĞºĞºĞµĞ¹', stressIdx: 4, root: 'Ñ…Ğ¾ĞºĞºĞµ', cn: 'å†°çƒ', lesson: 1, related: 'Ñ…Ğ¾ĞºĞºĞµĞ¸ÌÑÑ‚ (å†°çƒè¿åŠ¨å‘˜)' },
          { ru: 'ÑĞºÑĞºÑƒÑ€ÑĞ¸Ñ', stressIdx: 4, root: 'ĞºÑƒÑ€Ñ', cn: 'å‚è§‚', lesson: 1, related: 'ĞºÑƒÑ€Ñ (èˆªå‘/è¯¾ç¨‹)' },
          { ru: 'Ğ²Ñ‡ĞµÑ€Ğ°', stressIdx: 4, root: 'Ğ²Ñ‡ĞµÑ€Ğ°', cn: 'æ˜¨å¤©', lesson: 1, related: 'Ğ²Ñ‡ĞµÑ€Ğ°ÌÑˆĞ½Ğ¸Ğ¹ (æ˜¨å¤©çš„)' },
          { ru: 'Ñ€Ğ°Ğ½ÑŒÑˆĞµ', stressIdx: 1, root: 'Ñ€Ğ°Ğ½', cn: 'åŸå…ˆ', lesson: 1, related: 'Ñ€Ğ°ÌĞ½Ğ¾ (æ—©)' },
          { ru: 'ÑĞµĞ³Ğ¾Ğ´Ğ½Ñ', stressIdx: 3, root: 'ÑĞµĞ³Ğ¾Ğ´', cn: 'ä»Šå¤©', lesson: 1, related: 'ÑĞµĞ¹ (æ­¤) + Ğ´Ğ½Ñ (æ—¥)' },
          { ru: 'Ñ‚ĞµĞ¿ĞµÑ€ÑŒ', stressIdx: 3, root: 'Ñ‚ĞµĞ¿ĞµÑ€', cn: 'ç°åœ¨', lesson: 1, related: 'Ñ‚ĞµĞ¿ĞµÌÑ€ĞµÑˆĞ½Ğ¸Ğ¹ (ç°åœ¨çš„)' },
          { ru: 'Ğ²ĞµÑÑŒ', stressIdx: 1, root: 'Ğ²Ğµ', cn: 'å…¨éƒ¨', lesson: 1, related: 'Ğ²ÑĞµ (å¤§å®¶), Ğ²ÑÑ‘ (ä¸€åˆ‡)' },
          { ru: 'Ğ½Ğ¸Ñ‡Ñ‚Ğ¾', stressIdx: 4, root: 'Ğ½Ğ¸Ñ‡', cn: 'ä»€ä¹ˆä¹Ÿ(ä¸)', lesson: 1, related: 'Ğ½Ğ¸Ñ‡ĞµĞ³Ğ¾Ì (æ²¡ä»€ä¹ˆ)' },
          { ru: 'Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹', stressIdx: 4, root: 'Ğ²Ñ‚Ğ¾Ñ€', cn: 'ç¬¬äºŒ', lesson: 1, related: 'Ğ²Ñ‚Ğ¾ÌÑ€Ğ½Ğ¸Ğº (å‘¨äºŒ)' },
          { ru: 'Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹', stressIdx: 1, root: 'Ğ¿ĞµÑ€Ğ²', cn: 'ç¬¬ä¸€', lesson: 1, related: 'Ğ²Ğ¿ĞµÌÑ€Ğ²Ñ‹Ğµ (åˆæ¬¡)' },
          { ru: 'Ğ¿Ğ¾ÑĞ»Ğµ', stressIdx: 1, root: 'Ğ¿Ğ¾ÑĞ»', cn: 'åœ¨...ä¹‹å', lesson: 1, related: 'Ğ¿Ğ¾ÑĞ»ĞµÌĞ´Ğ½Ğ¸Ğ¹ (æœ€åçš„)' },
          { ru: 'Ğ¸Ğ·Ğ²Ğ¸Ğ½Ğ¸', stressIdx: 5, root: 'Ğ²Ğ¸Ğ½', cn: 'å¯¹ä¸èµ·', lesson: 1, related: 'Ğ²Ğ¸Ğ½Ğ°Ì (è¿‡é”™)' },
          { ru: 'Ğ±Ñ‹Ñ‚ÑŒ', stressIdx: -1, root: 'Ğ±Ñ‹', cn: 'æ˜¯/åœ¨', lesson: 1, related: 'Ğ±ÑƒÌĞ´Ñƒ (å°†æ˜¯)', grammar: { type: 'æœªå®Œæˆä½“', perfective: '-', conj: 'Ğ±ÑƒÌĞ´Ñƒ, Ğ±ÑƒÌĞ´ĞµÑˆÑŒ, Ğ±ÑƒÌĞ´ÑƒÑ‚' } },
          { ru: 'Ğ²Ğ¸Ğ´ĞµÑ‚ÑŒ', stressIdx: 1, root: 'Ğ²Ğ¸Ğ´', cn: 'çœ‹è§', lesson: 1, related: 'Ğ²Ğ¸ÌĞ´Ğ¸Ğ¼Ñ‹Ğ¹ (å¯è§çš„)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'ÑƒĞ²Ğ¸ÌĞ´ĞµÑ‚ÑŒ (-Ğ¶Ñƒ, -Ğ´Ğ¸ÑˆÑŒ)', conj: 'Ğ²Ğ¸ÌĞ¶Ñƒ, Ğ²Ğ¸ÌĞ´Ğ¸ÑˆÑŒ, Ğ²Ğ¸ÌĞ´ÑÑ‚' } },
          { ru: 'Ğ·Ğ°Ğ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ñ‚ÑŒ', stressIdx: 7, root: 'Ğ¼Ğ¸Ğ½', cn: 'è®°ä½', lesson: 1, related: 'Ğ¿Ğ°ÌĞ¼ÑÑ‚ÑŒ (è®°å¿†)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ğ·Ğ°Ğ¿Ğ¾ÌĞ¼Ğ½Ğ¸Ñ‚ÑŒ (-Ğ½Ñ, -Ğ½Ğ¸ÑˆÑŒ)', conj: '-Ğ°ÌÑ, -Ğ°ÌĞµÑˆÑŒ, -Ğ°ÌÑÑ‚' } },
          { ru: 'Ğ¸ÑĞºĞ°Ñ‚ÑŒ', stressIdx: 3, root: 'Ğ¸ÑĞº', cn: 'å¯»æ‰¾', lesson: 1, related: 'Ğ¿Ğ¾ÌĞ¸ÑĞº (æœç´¢)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ğ½Ğ°Ğ¹Ñ‚Ğ¸Ì (Ğ½Ğ°Ğ¹Ğ´ÑƒÌ)', conj: 'Ğ¸Ñ‰ÑƒÌ, Ğ¸ÌÑ‰ĞµÑˆÑŒ, Ğ¸ÌÑ‰ÑƒÑ‚' } },
          { ru: 'Ğ¿ĞµÑ‚ÑŒ', stressIdx: 1, root: 'Ğ¿Ğµ', cn: 'å”±æ­Œ', lesson: 1, related: 'Ğ¿ĞµÌÑĞ½Ñ (æ­Œæ›²)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'ÑĞ¿ĞµÑ‚ÑŒ (ÑĞ¿Ğ¾ÑÌ)', conj: 'Ğ¿Ğ¾ÑÌ, Ğ¿Ğ¾Ñ‘ÑˆÑŒ, Ğ¿Ğ¾ÑÌÑ‚' } },
          { ru: 'Ğ¿Ğ¾Ğ¼Ğ½Ğ¸Ñ‚ÑŒ', stressIdx: 1, root: 'Ğ¿Ğ¾Ğ¼Ğ½', cn: 'è®°å¾—', lesson: 1, related: 'Ğ¿Ğ°ÌĞ¼ÑÑ‚ÑŒ (è®°å¿†)', grammar: { type: 'æœªå®Œæˆä½“', perfective: '-', conj: '-Ğ½Ñ, -Ğ½Ğ¸ÑˆÑŒ, -Ğ½ÑÑ‚' } },
          { ru: 'Ñ‚Ğ°Ğ½Ñ†ĞµĞ²Ğ°Ñ‚ÑŒ', stressIdx: 6, root: 'Ñ‚Ğ°Ğ½Ñ†', cn: 'è·³èˆ', lesson: 1, related: 'Ñ‚Ğ°ÌĞ½ĞµÑ† (èˆè¹ˆ)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'ÑÑ‚Ğ°Ğ½Ñ†ĞµĞ²Ğ°ÌÑ‚ÑŒ', conj: 'Ñ‚Ğ°Ğ½Ñ†ÑƒÌÑ, -Ñ†ÑƒÌĞµÑˆÑŒ' } },

          // Lesson 2
          { ru: 'Ğ³Ğ¾Ğ´', stressIdx: -1, root: 'Ğ³Ğ¾Ğ´', cn: 'å¹´', lesson: 2, related: 'Ğ³Ğ¾Ğ´Ğ¾Ğ²Ğ¾ÌĞ¹ (å¹´åº¦çš„)' },
          { ru: 'Ğ¶Ğ¸Ğ·Ğ½ÑŒ', stressIdx: 1, root: 'Ğ¶Ğ¸', cn: 'ç”Ÿæ´»', lesson: 2, related: 'Ğ¶Ğ¸Ñ‚ÑŒ (ç”Ÿæ´»/å±…ä½)' },
          { ru: 'Ğ¼ĞµÑÑÑ†', stressIdx: 1, root: 'Ğ¼ĞµÑ', cn: 'æœˆ', lesson: 2, related: 'ĞµĞ¶ĞµĞ¼ĞµÌÑÑÑ‡Ğ½Ğ¾ (æ¯æœˆ)' },
          { ru: 'Ğ¼Ğ¸Ğ½ÑƒÑ‚Ğ°', stressIdx: 3, root: 'Ğ¼Ğ¸Ğ½ÑƒÑ‚', cn: 'åˆ†é’Ÿ', lesson: 2, related: 'Ğ¼Ğ¸Ğ½ÑƒÌÑ‚Ğ½Ñ‹Ğ¹ (åˆ†é’Ÿçš„)' },
          { ru: 'Ğ½ĞµĞ´ĞµĞ»Ñ', stressIdx: 3, root: 'Ğ½ĞµĞ´ĞµĞ»', cn: 'æ˜ŸæœŸ', lesson: 2, related: 'Ğ¿Ğ¾Ğ½ĞµĞ´ĞµÌĞ»ÑŒĞ½Ğ¸Ğº (å‘¨ä¸€)' },
          { ru: 'Ğ¿Ğ¾Ğ»Ğ¾Ğ²Ğ¸Ğ½Ğ°', stressIdx: 5, root: 'Ğ¿Ğ¾Ğ»', cn: 'ä¸€åŠ', lesson: 2, related: 'Ğ¿Ğ¾Ğ»Ñ‡Ğ°ÑĞ°Ì (åŠå°æ—¶)' },
          { ru: 'Ğ¿Ğ¾Ğ»Ñ‡Ğ°ÑĞ°', stressIdx: 6, root: 'Ğ¿Ğ¾Ğ»', cn: 'åŠå°æ—¶', lesson: 2, related: 'Ğ¿Ğ¾Ğ»Ğ¾Ğ²Ğ¸ÌĞ½Ğ° (ä¸€åŠ)' },
          { ru: 'Ñ€Ğ¾Ğ¼Ğ°Ğ½', stressIdx: 3, root: 'Ñ€Ğ¾Ğ¼Ğ°Ğ½', cn: 'å°è¯´', lesson: 2, related: 'Ñ€Ğ¾Ğ¼Ğ°Ğ½Ğ¸ÌÑÑ‚ (å°è¯´å®¶)' },
          { ru: 'ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ¸Ñ‚ĞµÑ‚', stressIdx: 9, root: 'ÑƒĞ½Ğ¸Ğ²ĞµÑ€', cn: 'å¤§å­¦', lesson: 2, related: 'ÑƒĞ½Ğ¸Ğ²ĞµÑ€ÑĞ°ÌĞ»ÑŒĞ½Ñ‹Ğ¹ (é€šç”¨çš„)' },
          { ru: 'Ñ‡Ğ°Ñ', stressIdx: 1, root: 'Ñ‡Ğ°Ñ', cn: 'å°æ—¶', lesson: 2, related: 'Ñ‡Ğ°ÑÑ‹Ì (è¡¨)' },
          { ru: 'Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğ¹', stressIdx: 2, root: 'Ğ´Ğ»Ğ¸Ğ½', cn: 'é•¿çš„', lesson: 2, related: 'Ğ´Ğ»Ğ¸Ğ½Ğ°Ì (é•¿åº¦)' },
          { ru: 'Ğ´Ğ¾Ğ»Ğ³Ğ¸Ğ¹', stressIdx: 1, root: 'Ğ´Ğ¾Ğ»Ğ³', cn: 'é•¿ä¹…çš„', lesson: 2, related: 'Ğ´Ğ¾ÌĞ»Ğ³Ğ¾ (å¾ˆä¹…)' },
          { ru: 'Ğ½Ğ¾Ñ€Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹', stressIdx: 4, root: 'Ğ½Ğ¾Ñ€Ğ¼', cn: 'æ­£å¸¸çš„', lesson: 2, related: 'Ğ½Ğ¾ÌÑ€Ğ¼Ğ° (è§„èŒƒ)' },
          { ru: 'ÑÑ‡Ğ°ÑÑ‚Ğ»Ğ¸Ğ²Ñ‹Ğ¹', stressIdx: 6, root: 'ÑÑ‡Ğ°ÑÑ‚', cn: 'å¹¸ç¦çš„', lesson: 2, related: 'ÑÑ‡Ğ°ÌÑÑ‚ÑŒĞµ (å¹¸ç¦)' },
          { ru: 'Ñ‚Ñ€ÑƒĞ´Ğ½Ñ‹Ğ¹', stressIdx: 2, root: 'Ñ‚Ñ€ÑƒĞ´', cn: 'å›°éš¾çš„', lesson: 2, related: 'Ñ‚Ñ€ÑƒĞ´ (åŠ³åŠ¨)' },
          { ru: 'Ğ½Ğ°ĞºĞ¾Ğ½ĞµÑ†', stressIdx: 5, root: 'ĞºĞ¾Ğ½', cn: 'æœ€ç»ˆ', lesson: 2, related: 'ĞºĞ¾Ğ½ĞµÌÑ† (ç»“æŸ)' },
          { ru: 'Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸', stressIdx: 4, root: 'Ğ¿Ğ¾Ñ‡Ñ‚', cn: 'å‡ ä¹', lesson: 2, related: 'Ğ¿Ğ¾Ñ‡Ñ‚Ğ¸ÌÑ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ (æ­æ•¬çš„)' },
          { ru: 'Ğ²ÑÑ‘', stressIdx: -1, root: 'Ğ²Ñ', cn: 'ä¸€åˆ‡', lesson: 2, related: 'Ğ²ĞµÑÑŒ (å…¨éƒ¨)' },
          { ru: 'Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°Ñ‚ÑŒÑÑ', stressIdx: 5, root: 'Ğ½Ğ¸Ğ¼', cn: 'å­¦ä¹ ', lesson: 2, related: 'Ğ·Ğ°Ğ½ÑÌÑ‚Ğ¸Ğµ (è¯¾)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ğ·Ğ°Ğ½ÑÌÑ‚ÑŒÑÑ', conj: '-Ğ°ÌÑÑÑŒ, -Ğ°ÌĞµÑˆÑŒÑÑ' } },
          { ru: 'Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑÑ‚ÑŒ', stressIdx: 6, root: 'Ğ²ĞµÑ€', cn: 'æ£€æŸ¥', lesson: 2, related: 'Ğ¿Ñ€Ğ¾Ğ²ĞµÌÑ€ĞºĞ° (æ ¸å®)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ğ¿Ñ€Ğ¾Ğ²ĞµÌÑ€Ğ¸Ñ‚ÑŒ', conj: '-ÑÌÑ, -ÑÌĞµÑˆÑŒ' } },
          { ru: 'Ñ€ĞµÑˆĞ°Ñ‚ÑŒ', stressIdx: 4, root: 'Ñ€ĞµÑˆ', cn: 'è§£å†³', lesson: 2, related: 'ç­”', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ñ€ĞµÑˆĞ¸ÌÑ‚ÑŒ (-ÑˆÑƒÌ)', conj: '-Ğ°ÌÑ, -Ğ°ÌĞµÑˆÑŒ' } },
          { ru: 'ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ', stressIdx: 3, root: 'ÑÑ‚Ñ€Ğ¾', cn: 'å»ºè®¾', lesson: 2, related: 'å»ºé€ ', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ğ¿Ğ¾ÑÑ‚Ñ€Ğ¾ÌĞ¸Ñ‚ÑŒ', conj: '-Ğ¾ÌÑ, -Ğ¾ÌĞ¸ÑˆÑŒ' } },
          { ru: 'ÑƒÑÑ‚Ğ°Ğ²Ğ°Ñ‚ÑŒ', stressIdx: 6, root: 'ÑÑ‚Ğ°', cn: 'ç–²åŠ³', lesson: 2, related: 'ç´¯', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'ÑƒÑÑ‚Ğ°ÌÑ‚ÑŒ (-Ğ°ÌĞ½Ñƒ)', conj: 'ÑƒÑÑ‚Ğ°ÑÌ, -Ğ°Ñ‘ÑˆÑŒ' } },
          { ru: 'Ñ…Ğ¾Ñ‚ĞµÑ‚ÑŒ', stressIdx: 4, root: 'Ñ…Ğ¾Ñ‚', cn: 'æƒ³è¦', lesson: 2, related: 'æ„¿æœ›', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'Ğ·Ğ°Ñ…Ğ¾Ñ‚ĞµÌÑ‚ÑŒ', conj: 'Ñ…Ğ¾Ñ‡ÑƒÌ, Ñ…Ğ¾ÌÑ‡ĞµÑˆÑŒ' } },

          // Lesson 3
          { ru: 'Ğ²ĞµÑĞ½Ğ°', stressIdx: 4, root: 'Ğ²ĞµÑĞ½', cn: 'æ˜¥å¤©', lesson: 3, related: 'Ğ²ĞµÑĞµÌĞ½Ğ½Ğ¸Ğ¹ (æ˜¥å¤©çš„)' },
          { ru: 'Ğ·Ğ¸Ğ¼Ğ°', stressIdx: 3, root: 'Ğ·Ğ¸Ğ¼', cn: 'å†¬å¤©', lesson: 3, related: 'Ğ·Ğ¸ÌĞ¼Ğ½Ğ¸Ğ¹ (å†¬å¤©çš„)' },
          { ru: 'ĞºĞ°Ğ½Ğ¸ĞºÑƒĞ»Ñ‹', stressIdx: 3, root: 'ĞºĞ°Ğ½Ğ¸Ğº', cn: 'å‡æœŸ', lesson: 3, related: 'ĞºĞ°Ğ½Ğ¸ĞºÑƒĞ»ÑÌÑ€Ğ½Ñ‹Ğ¹ (å‡æœŸçš„)' },
          { ru: 'Ğ»ĞµÑ‚Ğ¾', stressIdx: 1, root: 'Ğ»ĞµÑ‚', cn: 'å¤å¤©', lesson: 3, related: 'Ğ»ĞµÌÑ‚Ğ½Ğ¸Ğ¹ (å¤å¤©çš„)' },
          { ru: 'Ğ¾ÑĞµĞ½ÑŒ', stressIdx: 0, root: 'Ğ¾ÑĞµĞ½ÑŒ', cn: 'ç§‹å¤©', lesson: 3, related: 'Ğ¾ÑĞµÌĞ½Ğ½Ğ¸Ğ¹ (ç§‹å¤©çš„)' },
          { ru: 'Ñ„Ğ¸Ğ·Ğ¸ĞºĞ°', stressIdx: 1, root: 'Ñ„Ğ¸Ğ·', cn: 'ç‰©ç†', lesson: 3, related: 'Ñ„Ğ¸ÌĞ·Ğ¸Ğº (ç‰©ç†å­¦å®¶)' },
          { ru: 'Ğ¿Ğ¾Ğ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¸Ğº', stressIdx: 5, root: 'Ğ½ĞµĞ´ĞµĞ»ÑŒ', cn: 'å‘¨ä¸€', lesson: 3, related: 'Ğ½ĞµĞ´ĞµÌĞ»Ñ (æ˜ŸæœŸ)' },
          { ru: 'Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ¸Ğº', stressIdx: 2, root: 'Ğ²Ñ‚Ğ¾Ñ€', cn: 'å‘¨äºŒ', lesson: 3, related: 'Ğ²Ñ‚Ğ¾Ñ€Ğ¾ÌĞ¹ (ç¬¬äºŒ)' },
          { ru: 'ÑÑ€ĞµĞ´Ğ°', stressIdx: 4, root: 'ÑÑ€ĞµĞ´', cn: 'å‘¨ä¸‰', lesson: 3, related: 'ÑÑ€ĞµÌĞ´Ğ½Ğ¸Ğ¹ (ä¸­é—´çš„)' },
          { ru: 'Ñ‡ĞµÑ‚Ğ²ĞµÑ€Ğ³', stressIdx: 5, root: 'Ñ‡ĞµÑ‚Ğ²ĞµÑ€', cn: 'å‘¨å››', lesson: 3, related: 'Ñ‡ĞµÑ‚Ğ²Ñ‘Ñ€Ñ‚Ñ‹Ğ¹ (ç¬¬å››)' },
          { ru: 'Ğ¿ÑÑ‚Ğ½Ğ¸Ñ†Ğ°', stressIdx: 1, root: 'Ğ¿ÑÑ‚', cn: 'å‘¨äº”', lesson: 3, related: 'Ğ¿ÑÌÑ‚Ñ‹Ğ¹ (ç¬¬äº”)' },
          { ru: 'ÑÑƒĞ±Ğ±Ğ¾Ñ‚Ğ°', stressIdx: 4, root: 'ÑÑƒĞ±Ğ±Ğ¾Ñ‚', cn: 'å‘¨å…­', lesson: 3, related: 'ÑÑƒĞ±Ğ±Ğ¾ÌÑ‚Ğ½Ğ¸Ğ¹ (å‘¨å…­çš„)' },
          { ru: 'Ğ²Ğ¾ÑĞºÑ€ĞµÑĞµĞ½ÑŒĞµ', stressIdx: 8, root: 'Ğ²Ğ¾ÑĞºÑ€ĞµÑ', cn: 'å‘¨æ—¥', lesson: 3, related: 'Ğ²Ğ¾ÑĞºÑ€ĞµÑĞ°ÌÑ‚ÑŒ (å¤æ´»)' },
          { ru: 'Ğ²ĞµÑĞ½Ğ¾Ğ¹', stressIdx: 4, root: 'Ğ²ĞµÑĞ½', cn: '(åœ¨)æ˜¥å¤©', lesson: 3, related: 'Ğ²ĞµÑĞ½Ğ°Ì (æ˜¥å¤©)' },
          { ru: 'Ğ·Ğ¸Ğ¼Ğ¾Ğ¹', stressIdx: 3, root: 'Ğ·Ğ¸Ğ¼', cn: '(åœ¨)å†¬å¤©', lesson: 3, related: 'Ğ·Ğ¸Ğ¼Ğ°Ì (å†¬å¤©)' },
          { ru: 'Ğ»ĞµÑ‚Ğ¾Ğ¼', stressIdx: 1, root: 'Ğ»ĞµÑ‚', cn: '(åœ¨)å¤å¤©', lesson: 3, related: 'Ğ»ĞµÌÑ‚Ğ¾ (å¤å¤©)' },
          { ru: 'Ğ¾ÑĞµĞ½ÑŒÑ', stressIdx: 1, root: 'Ğ¾ÑĞµĞ½ÑŒ', cn: '(åœ¨)ç§‹å¤©', lesson: 3, related: 'Ğ¾ÌÑĞµĞ½ÑŒ (ç§‹å¤©)' },
          { ru: 'Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°', stressIdx: 1, root: 'Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°', cn: 'æ˜å¤©', lesson: 3, related: 'Ğ·Ğ°ÌĞ²Ñ‚Ñ€Ğ°Ğº (æ—©é¥­)' },
          { ru: 'Ğ¿Ğ¾ÑĞ»ĞµĞ·Ğ°Ğ²Ñ‚Ñ€Ğ°', stressIdx: 6, root: 'Ğ·Ğ°Ğ²Ñ‚Ñ€Ğ°', cn: 'åå¤©', lesson: 3, related: 'Ğ·Ğ°ÌĞ²Ñ‚Ñ€Ğ° (æ˜å¤©)' },
          { ru: 'Ğ½Ğ°Ğ¸Ğ·ÑƒÑÑ‚ÑŒ', stressIdx: 5, root: 'ÑƒÑÑ‚', cn: 'èƒŒç†Ÿ', lesson: 3, related: 'ÑƒÑÑ‚Ğ°Ì (å£/å˜´)' },
          { ru: 'ÑĞºĞ¾Ñ€Ğ¾', stressIdx: 2, root: 'ÑĞºĞ¾Ñ€', cn: 'å¾ˆå¿«', lesson: 3, related: 'ÑĞºĞ¾ÌÑ€Ğ¾ÑÑ‚ÑŒ (é€Ÿåº¦)' },
          { ru: 'Ñ‡ĞµÑ€ĞµĞ·', stressIdx: 1, root: 'Ñ‡ĞµÑ€', cn: 'ç»è¿‡', lesson: 3, related: 'Ñ‡ĞµÑ€ĞµĞ·Ğ¼ĞµÌÑ€Ğ½Ñ‹Ğ¹ (è¿‡åº¦çš„)' },
          { ru: 'Ğ´Ğ¾ Ğ²ÑÑ‚Ñ€ĞµÑ‡Ğ¸', stressIdx: 7, root: 'Ğ²ÑÑ‚Ñ€ĞµÑ‡', cn: 'å†è§', lesson: 3, related: 'Ğ²ÑÑ‚Ñ€ĞµÌÑ‡Ğ° (è§é¢)' },
          { ru: 'ÑĞ»Ñ‹ÑˆĞ°Ñ‚ÑŒ', stressIdx: 2, root: 'ÑĞ»Ñ‹Ñ…', cn: 'å¬è§', lesson: 3, related: 'ÑĞ»ÑƒÑ… (å¬åŠ›)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'ÑƒÑĞ»Ñ‹ÌÑˆĞ°Ñ‚ÑŒ', conj: 'ÑĞ»Ñ‹ÌÑˆÑƒ, ÑĞ»Ñ‹ÌÑˆĞ¸ÑˆÑŒ' } },
          { ru: 'ÑĞ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚ÑŒ', stressIdx: 5, root: 'Ğ±Ğ¸Ñ€', cn: 'æ”¶é›†', lesson: 3, related: 'ÑĞ¾Ğ±Ñ€Ğ°ÌĞ½Ğ¸Ğµ (ä¼šè®®)', grammar: { type: 'æœªå®Œæˆä½“', perfective: 'ÑĞ¾Ğ±Ñ€Ğ°ÌÑ‚ÑŒ', conj: '-Ğ°ÌÑ, -Ğ°ÌĞµÑˆÑŒ' } },
        ];

        // --- ç»„ä»¶ ---
        
        // å•è¯æ¸²æŸ“ - ç´§å‡‘æ’ç‰ˆä¸é‡éŸ³ä¿®å¤ (Pro Max ç‰ˆ)
        const WordDisplay = ({ word, root, stressIdx, size = 'lg', isWhite = false }) => {
            if (!word) return null;
            return (
                <div className={`word-display text-${size} ${isWhite ? 'text-white' : ''}`}>
                    {word.split('').map((char, idx) => {
                        const isRoot = word.indexOf(root) !== -1 && idx >= word.indexOf(root) && idx < word.indexOf(root) + root.length;
                        const hasStress = idx === stressIdx;
                        let classes = 'char';
                        if (!isWhite && isRoot) classes += ' root';
                        return (
                            <span key={idx} className="char-container">
                                <span className={classes}>{char}</span>
                                {hasStress && <span className="stress-mark">Ì</span>}
                            </span>
                        );
                    })}
                </div>
            );
        };

        const ConjDisplay = ({ text, isWhite = false }) => {
            if (!text) return null;
            const parts = [];
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === ' ') { parts.push(<span key={i} style={{width:'5px'}}></span>); continue; }
                const isStress = text[i+1] === '\u0301' || text[i+1] === 'Ì'; 
                if (isStress) {
                    parts.push(
                        <span key={i} className={isWhite ? "conj-back" : "conj-front"} style={{position:'relative', display:'inline-block', margin: '0 -0.01em'}}>
                            <span style={{fontWeight:'bold'}}>{char}</span>
                            <span className="stress-mark stress-small" style={{top: '0.05em', left:'50%', transform:'translateX(-45%)'}}>Ì</span>
                        </span>
                    );
                    i++; 
                } else { parts.push(<span key={i}>{char}</span>); }
            }
            return <div style={{display:'flex', flexWrap:'wrap', justifyContent:'center', fontStyle:'italic'}}>{parts}</div>;
        };

        const App = () => {
            const [activeLesson, setActiveLesson] = useState(1);
            const [mode, setMode] = useState('flashcard');
            const [currentIndex, setCurrentIndex] = useState(0);
            const [isFlipped, setIsFlipped] = useState(false);
            
            // Match state
            const [matchItems, setMatchItems] = useState([]);
            const [selected, setSelected] = useState([]);
            const [solved, setSolved] = useState([]);
            
            // Quiz state
            const [quizQueue, setQuizQueue] = useState([]);
            const [quizIndex, setQuizIndex] = useState(0);
            const [quizQuestion, setQuizQuestion] = useState(null);
            const [quizOptions, setQuizOptions] = useState([]);
            const [quizAnswered, setQuizAnswered] = useState(false);
            const [quizCorrect, setQuizCorrect] = useState(false);
            const [quizScore, setQuizScore] = useState(0);
            const [quizStats, setQuizStats] = useState({ correct: 0, total: 0 });
            const [quizFinished, setQuizFinished] = useState(false);

            // è§¦æ‘¸æ»‘åŠ¨å¤„ç†
            const [touchStart, setTouchStart] = useState(null);
            const [touchEnd, setTouchEnd] = useState(null);
            const minSwipeDistance = 50;

            const onTouchStart = (e) => {
                setTouchEnd(null);
                setTouchStart(e.targetTouches[0].clientX);
            };

            const onTouchMove = (e) => {
                setTouchEnd(e.targetTouches[0].clientX);
            };

            // æ»‘åŠ¨é€»è¾‘ï¼šå·¦æ»‘=ä¸‹ä¸€ä¸ªï¼Œå³æ»‘=ä¸Šä¸€ä¸ª
            const onTouchEnd = () => {
                if (!touchStart || !touchEnd) return;
                const distance = touchStart - touchEnd;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                
                if (isLeftSwipe) {
                    goNext();
                }
                if (isRightSwipe) {
                    goPrev();
                }
            };

            const currentVocab = useMemo(() => {
                const list = activeLesson === 0 ? vocabulary : vocabulary.filter(v => v.lesson === activeLesson);
                return list.length > 0 ? list : [vocabulary[0]];
            }, [activeLesson]);

            // Reset
            useEffect(() => {
                setCurrentIndex(0); setIsFlipped(false);
                setQuizFinished(false); setQuizQueue([]); setQuizScore(0);
                setQuizStats({ correct: 0, total: 0 });
            }, [activeLesson]);

            const goNext = () => {
                setCurrentIndex((prev) => (prev + 1) % currentVocab.length);
                setIsFlipped(false);
            };

            const goPrev = () => {
                setCurrentIndex((prev) => (prev - 1 + currentVocab.length) % currentVocab.length);
                setIsFlipped(false);
            };

            // Logic Init
            const initMatch = () => {
                const subset = [...currentVocab].sort(() => 0.5 - Math.random()).slice(0, 6);
                const items = [
                    ...subset.map(v => ({ ...v, type: 'ru', id: v.ru })),
                    ...subset.map(v => ({ ...v, type: 'cn', id: v.ru }))
                ].sort(() => 0.5 - Math.random());
                setMatchItems(items); setSelected([]); setSolved([]);
            };

            const startQuizRound = useCallback(() => {
                const queue = [...currentVocab].sort(() => 0.5 - Math.random());
                setQuizQueue(queue); setQuizIndex(0); setQuizScore(0);
                setQuizStats({ correct: 0, total: 0 }); setQuizFinished(false);
                generateQuestion(queue[0]);
            }, [currentVocab]);

            const generateQuestion = (target) => {
                let distractors = vocabulary.filter(w => w.ru !== target.ru).sort(() => 0.5 - Math.random()).slice(0, 3);
                const dir = Math.random() > 0.5 ? 'ru-cn' : 'cn-ru';
                const opts = [target, ...distractors].sort(() => 0.5 - Math.random());
                setQuizQuestion({ ...target, dir }); setQuizOptions(opts); setQuizAnswered(false);
            };

            const nextQuizQuestion = () => {
                const nextIdx = quizIndex + 1;
                if (nextIdx >= quizQueue.length) {
                    setQuizFinished(true);
                } else {
                    setQuizIndex(nextIdx);
                    generateQuestion(quizQueue[nextIdx]);
                }
            };

            useEffect(() => {
                if (mode === 'match') initMatch();
                if (mode === 'quiz' && quizQueue.length === 0 && !quizFinished) startQuizRound();
            }, [mode, activeLesson, startQuizRound, quizQueue.length, quizFinished]);

            const handleMatch = (item) => {
                if (solved.includes(item.id) || selected.includes(item)) return;
                const newSel = [...selected, item]; setSelected(newSel);
                if (newSel.length === 2) {
                    if (newSel[0].id === newSel[1].id && newSel[0].type !== newSel[1].type) setSolved([...solved, newSel[0].id]);
                    setTimeout(() => setSelected([]), 400);
                }
            };

            const handleQuiz = (opt) => {
                if (quizAnswered) return;
                setQuizAnswered(true);
                const isCorrect = opt.ru === quizQuestion.ru;
                setQuizStats(p => ({ correct: p.correct + (isCorrect ? 1 : 0), total: p.total + 1 }));
                if (isCorrect) {
                    setQuizCorrect(true); setQuizScore(s => s + 10);
                    setTimeout(nextQuizQuestion, 1000);
                } else setQuizCorrect(false);
            };

            const accuracy = quizStats.total > 0 ? Math.round((quizStats.correct / quizStats.total) * 100) : 0;

            return (
                <div className="app-wrapper">
                    <header className="header">
                        <div className="brand">
                            <div className="logo"><Icons.BookOpen /></div>
                            <div className="title"><h1>ä¿„è¯­å•è¯è‡ªä¿®å®¤</h1><p>Morandi Style</p></div>
                        </div>
                        <div className="btn-group">
                            {['flashcard', 'match', 'quiz'].map(m => (
                                <button key={m} onClick={() => setMode(m)} className={`btn ${mode === m ? 'active' : ''}`}>
                                    {m === 'flashcard' ? 'é—ªå¡' : m === 'match' ? 'è¿è¿çœ‹' : 'æµ‹è¯•'}
                                </button>
                            ))}
                        </div>
                    </header>

                    <div className="lesson-nav">
                        {[1, 2, 3, 0].map(n => (
                            <button key={n} onClick={() => setActiveLesson(n)} className={`lesson-btn ${activeLesson === n ? 'active' : ''}`}>
                                {n === 0 ? 'å…¨éƒ¨' : `L${n}`}
                            </button>
                        ))}
                    </div>

                    {mode === 'flashcard' && (
                        <div style={{width:'100%', display:'flex', flexDirection:'column', alignItems:'center'}}>
                            <div className="card-container" 
                                 onClick={() => setIsFlipped(!isFlipped)}
                                 onTouchStart={onTouchStart}
                                 onTouchMove={onTouchMove}
                                 onTouchEnd={onTouchEnd}
                            >
                                <div className={`card-inner ${isFlipped ? 'flipped' : ''}`}>
                                    <div className="card-face card-front">
                                        <div style={{position:'absolute', top:'20px', left:'20px', color:'#7A8665', fontWeight:'bold', fontSize:'0.8rem', display:'flex', gap:'5px', alignItems:'center'}}>
                                            <Icons.Layers /> Lesson {currentVocab[currentIndex]?.lesson}
                                        </div>
                                        <WordDisplay word={currentVocab[currentIndex]?.ru} root={currentVocab[currentIndex]?.root} stressIdx={currentVocab[currentIndex]?.stressIdx} size="lg" />
                                        {currentVocab[currentIndex]?.grammar && (
                                            <div style={{marginTop:'20px', fontSize:'1.2rem', color:'#7A8665'}}>
                                                <ConjDisplay text={currentVocab[currentIndex].grammar.conj} />
                                            </div>
                                        )}
                                        <div style={{position:'absolute', bottom:'20px', color:'#D9D8D2', fontSize:'0.7rem', fontWeight:'bold', letterSpacing:'2px', display:'flex', gap:'5px', alignItems:'center'}}><Icons.RefreshCw /> CLICK TO FLIP</div>
                                    </div>
                                    <div className="card-back">
                                        <div className="back-content">
                                            <div className="cn-mean cn-font">{currentVocab[currentIndex]?.cn}</div>
                                            {currentVocab[currentIndex]?.grammar && (
                                                <div className="info-card">
                                                    <div className="info-label">GRAMMAR</div>
                                                    <div style={{fontSize:'0.9rem'}}>
                                                        <div style={{fontWeight:'bold'}}>{currentVocab[currentIndex].grammar.type}</div>
                                                        <div>å®Œæˆä½“: {currentVocab[currentIndex].grammar.perfective}</div>
                                                        <div style={{marginTop:'5px', fontSize:'0.85em', opacity:0.9}}>
                                                            <ConjDisplay text={currentVocab[currentIndex].grammar.conj} isWhite={true} />
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                            <div className="info-card">
                                                <div className="info-label">ETYMOLOGY</div>
                                                <div style={{fontSize:'0.9rem'}}>
                                                    <div>è¯æ ¹: <strong>"{currentVocab[currentIndex]?.root}"</strong></div>
                                                    <div className="cn-font" style={{fontSize:'0.85rem', marginTop:'3px'}}>å…³è”: {currentVocab[currentIndex]?.related}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="controls">
                                <button className="nav-btn" onClick={goPrev}><Icons.ChevronLeft /></button>
                                <div className="slider-container">
                                    <input type="range" min="0" max={currentVocab.length - 1} value={currentIndex} onChange={e => {setCurrentIndex(parseInt(e.target.value)); setIsFlipped(false);}} className="slider" />
                                    <div className="progress-text">{currentIndex + 1} / {currentVocab.length}</div>
                                </div>
                                <button className="nav-btn" onClick={goNext}><Icons.ChevronRight /></button>
                            </div>
                        </div>
                    )}

                    {mode === 'match' && (
                        <div className="game-panel">
                            <div style={{display:'flex', justifyContent:'space-between', marginBottom:'20px', alignItems:'flex-end'}}>
                                <div><span className="info-label">MATCHING</span><div style={{fontSize:'1.5rem', fontWeight:'bold'}}>{solved.length} / 6</div></div>
                                <button onClick={initMatch} style={{border:'none', background:'transparent', color:'#7A8665', cursor:'pointer'}}><Icons.RefreshCw /></button>
                            </div>
                            <div className="game-grid">
                                {matchItems.map((item, idx) => (
                                    <button key={idx} disabled={solved.includes(item.id)} onClick={() => handleMatch(item)} className={`game-btn ${selected.includes(item) ? 'selected' : ''} ${solved.includes(item.id) ? 'solved' : ''}`}>
                                        {solved.includes(item.id) ? <Icons.Check /> : (item.type === 'ru' ? <WordDisplay word={item.ru} root={item.root} stressIdx={item.stressIdx} size="md" /> : <span className="cn-font">{item.cn}</span>)}
                                    </button>
                                ))}
                            </div>
                        </div>
                    )}

                    {mode === 'quiz' && (
                        <div className="game-panel" style={{display:'flex', flexDirection:'column', justifyContent:'center', textAlign:'center', minHeight:'400px'}}>
                            {!quizFinished && quizQuestion ? (
                                <>
                                    <div style={{display:'flex', justifyContent:'space-between', marginBottom:'30px'}}>
                                        <div style={{textAlign:'left'}}><span style={{fontSize:'2rem', fontWeight:'bold'}}>{quizScore}</span><span className="info-label" style={{display:'block'}}>SCORE</span></div>
                                        <div style={{textAlign:'right', fontSize:'0.8rem', color:'#7A8665', fontWeight:'bold'}}><div>è¿›åº¦: {quizIndex + 1} / {quizQueue.length}</div><div>æ­£ç¡®ç‡: {accuracy}%</div></div>
                                    </div>
                                    <div style={{marginBottom:'30px', minHeight:'80px', display:'flex', alignItems:'center', justifyContent:'center'}}>
                                        {quizQuestion.dir === 'ru-cn' ? <WordDisplay word={quizQuestion.ru} root={quizQuestion.root} stressIdx={quizQuestion.stressIdx} size="lg" /> : <h2 className="cn-font" style={{fontSize:'2rem', fontWeight:'bold'}}>{quizQuestion.cn}</h2>}
                                    </div>
                                    <div style={{display:'grid', gridTemplateColumns:'1fr', gap:'10px'}}>
                                        {quizOptions.map((opt, idx) => {
                                            const isCorrect = opt.ru === quizQuestion.ru;
                                            let statusClass = '';
                                            if (quizAnswered) statusClass = isCorrect ? 'correct' : (opt === quizQuestion ? 'correct' : 'wrong');
                                            return (
                                                <button key={idx} disabled={quizAnswered} onClick={() => handleQuiz(opt)} className={`quiz-option ${statusClass}`}>
                                                    {quizQuestion.dir === 'ru-cn' ? <span className="cn-font">{opt.cn}</span> : <span style={{fontFamily:'"Times New Roman", serif'}}>{opt.ru}</span>}
                                                </button>
                                            )
                                        })}
                                    </div>
                                    <div style={{marginTop:'20px', height:'20px', fontWeight:'bold', color:'#7A8665'}}>
                                        {quizAnswered && (quizCorrect ? "ğŸ‰ æ­£ç¡®!" : <button onClick={nextQuizQuestion} style={{background:'none', border:'none', textDecoration:'underline', color:'#BC8A7B', cursor:'pointer'}}>è·³è¿‡ â”</button>)}
                                    </div>
                                </>
                            ) : (
                                <div>
                                    <Icons.Award />
                                    <h2 className="cn-font" style={{fontSize:'1.5rem', fontWeight:'bold', margin:'20px 0'}}>æµ‹è¯•å®Œæˆ</h2>
                                    <div style={{display:'flex', justifyContent:'space-around', background:'#F7F5F0', padding:'20px', borderRadius:'15px', marginBottom:'30px'}}>
                                        <div><span className="info-label">Score</span><div style={{fontSize:'1.8rem', fontWeight:'bold', color:'#7A8665'}}>{quizScore}</div></div>
                                        <div><span className="info-label">Accuracy</span><div style={{fontSize:'1.8rem', fontWeight:'bold', color:'#7A8665'}}>{accuracy}%</div></div>
                                    </div>
                                    <button onClick={startQuizRound} style={{background:'#7A8665', color:'white', border:'none', padding:'12px 30px', borderRadius:'12px', fontSize:'1rem', fontWeight:'bold', cursor:'pointer', display:'inline-flex', alignItems:'center', gap:'10px'}}><Icons.RefreshCw /> å†æ¥ä¸€è½®</button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
